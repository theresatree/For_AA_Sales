<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Filter and Excel Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        textarea { width: 100%; height: 200px; }
        button { margin-top: 10px; }
        table { width: 50%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .green { background-color: green; }
        .red { background-color: red; }
        .black { background-color: black; }
        .empty { background-color: white; }
    </style>
</head>
<body>
    <h1>Filter Data and Generate Excel</h1>
    <p>Paste your data below (e.g., "A TOH GUAN ROAD #02-50"):</p>
    <textarea id="inputData" placeholder="Paste data here..."></textarea>
    <button onclick="processData()">Process Data</button>
    
    <h3>Filtered Data:</h3>
    <table id="dataTable">
        <thead>
            <!-- Dynamic header will be added after processing -->
        </thead>
        <tbody>
            <!-- Filtered data will appear here -->
        </tbody>
    </table>
    
    <button onclick="generateExcel()">Generate Excel</button>

    <script>
        function processData() {
            const inputData = document.getElementById('inputData').value.trim();
            const rows = inputData.split('\n');
            const levelData = {};
            const unitNumbers = new Set(); // To collect all unique unit numbers
            let level1Data = {}; // For saving Level 1 data separately

            // Process each row
            rows.forEach(row => {
                const columns = row.split(/\s+/);
                if (columns.length >= 3) {
                    const code = columns[0].toUpperCase();
                    const unit = columns[columns.length - 1].trim();

                    // Extract row and column from the unit (e.g., #02-50 becomes 02 and 50)
                    const unitParts = unit.replace('#', '').split('-');
                    if (unitParts.length === 2) {
                        const level = unitParts[0];  // Extract the row (level)
                        const unitNumber = unitParts[1];  // Extract the unit number

                        // Only include rows where the code is "A" or "C", or " " (space)
                        if (code === 'A' || code === 'C' || code === ' ') {
                            if (!levelData[level]) {
                                levelData[level] = {};
                            }
                            // Save Level 1 data separately
                            if (level === '01') {
                                level1Data[unitNumber] = code === ' ' ? '' : code;
                            } else {
                                levelData[level][unitNumber] = (code === ' ') ? '' : code;
                            }

                            unitNumbers.add(unitNumber); // Add unit number to the set
                        }
                    }
                }
            });

            // Convert unitNumbers to a sorted array, but ensure #01 is always the last one
            let unitArray = Array.from(unitNumbers).sort((a, b) => parseInt(a) - parseInt(b));
            if (unitArray.includes('01')) {
                unitArray = unitArray.filter(unit => unit !== '01');  // Remove #01 temporarily
                unitArray.push('01');  // Add #01 at the end
            }

            // Create table headers dynamically based on the unique unit numbers
            const tableHeader = document.getElementById('dataTable').getElementsByTagName('thead')[0];
            tableHeader.innerHTML = ''; // Clear any previous headers
            const headerRow = document.createElement('tr');
            headerRow.appendChild(document.createElement('th')).textContent = 'Level';
            unitArray.forEach(unit => {
                const th = document.createElement('th');
                th.textContent = unit;
                headerRow.appendChild(th);
            });
            tableHeader.appendChild(headerRow);

            // Populate the table with the filtered data
            const tableBody = document.getElementById('dataTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = ''; // Clear previous results

            // Sort levels numerically
            const levels = Object.keys(levelData).sort((a, b) => parseInt(a) - parseInt(b));

            levels.forEach(level => {
                const tr = document.createElement('tr');
                const tdLevel = document.createElement('td');
                tdLevel.textContent = level;
                tr.appendChild(tdLevel);

                let levelHasUnitNumber = false; // To check if any unit exists for the current level

                unitArray.forEach(unit => {
                    const td = document.createElement('td');
                    const value = levelData[level][unit] || '';
                    let cellColor = '';

                    // Apply the appropriate styles (colors only, no text)
                    if (value === 'A') {
                        cellColor = 'green';
                    } else if (value === 'C') {
                        cellColor = 'red';
                    } else if (value === '') {
                        cellColor = 'empty';
                    } else {
                        cellColor = 'black';
                    }

                    // If level has no unit number, color the cell black
                    if (value === '') {
                        cellColor = 'black';
                    } else {
                        levelHasUnitNumber = true; // Mark that level has a unit number
                    }

                    td.classList.add(cellColor);
                    tr.appendChild(td);
                });

                // Only add the row if the level has at least one unit number
                if (levelHasUnitNumber) {
                    tableBody.appendChild(tr);
                }
            });

            // Add Level 1 data at the last row if there is any data for Level 1
            if (Object.keys(level1Data).length > 0) {
                const level1Row = document.createElement('tr');
                const tdLevel1 = document.createElement('td');
                tdLevel1.textContent = '1'; // Level 1
                level1Row.appendChild(tdLevel1);

                unitArray.forEach(unit => {
                    const td = document.createElement('td');
                    const value = level1Data[unit] || '';
                    let cellColor = '';

                    // Apply the appropriate styles for Level 1 (colors only, no text)
                    if (value === 'A') {
                        cellColor = 'green';
                    } else if (value === 'C') {
                        cellColor = 'red';
                    } else if (value === '') {
                        cellColor = 'empty';
                    } else {
                        cellColor = 'black';
                    }

                    td.classList.add(cellColor);
                    level1Row.appendChild(td);
                });

                tableBody.appendChild(level1Row);
            }
        }

        function generateExcel() {
            const table = document.getElementById("dataTable");

            // Manually adjust the width of the columns before export
            const ws = XLSX.utils.table_to_sheet(table, { sheet: "Sheet1" });

            // Set the column widths to make the table more compact (50% width)
            const colWidth = [];
            for (let i = 0; i < table.rows[0].cells.length; i++) {
                colWidth.push({ wpx: 80 });  // Adjust column width (e.g., 80px)
            }

            ws['!cols'] = colWidth;

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");

            // Export to Excel file
            XLSX.writeFile(wb, "filtered_data.xlsx");
        }
    </script>
</body>
</html>
