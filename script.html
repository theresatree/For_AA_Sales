<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Filter and Excel Generator for AA Sales</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        /* Previous styles remain the same */
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        textarea {
            width: 30%;
            height: 200px;
            margin: 0 auto;
            display: block;
        }
        button {
            margin: 10px;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover {
            background-color: #45a049;
        }
        table { 
            width: 50%; 
            border-collapse: collapse; 
            margin: 20px auto;
            user-select: all;
        }
        th, td { 
            border: 1px solid #ddd; 
            padding: 8px; 
            text-align: center;
            vertical-align: middle;
            min-width: 30px; /* Added minimum width */
            height: 30px; /* Added minimum height */
        }
        h1, h3, p, div {
            text-align: center;
            width: 100%;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            width: 100%;
        }
        .button-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            width: 100%;
        }
    </style>
</head>
<body>
    <h1>Filter Data and Generate Excel for AA Sales</h1>
    <p>Paste your data below (e.g., "A TOH GUAN ROAD #02-50"):</p>
    <textarea id="inputData" placeholder="Paste data here..."></textarea>
    <div class="controls">
        <button onclick="processData()">Process Data</button>
        <button onclick="clearData()">Clear Data</button>
    </div>

    <h3>Filtered Data:</h3>
    <div>You can choose to copy the table with or without the "Level" column.</div>
    <table id="dataTable">
        <thead></thead>
        <tbody></tbody>
    </table>

    <div class="button-group">
        <button onclick="copyTable(false)">Copy without level</button>
        <button onclick="copyTable(true)">Copy with level</button>
    </div>

    <script>
        function processData() {
            const inputData = document.getElementById('inputData').value.trim();
            const rows = inputData.split('\n');
            const levelData = {};
            const unitNumbers = new Set();

            rows.forEach(row => {
                const columns = row.trim().split(/[\t\s]+/);
                if (columns.length >= 3) {
                    let code = columns[0].trim();
                    const unit = columns[columns.length - 1].trim();

                    const unitParts = unit.replace('#', '').split('-');
                    if (unitParts.length === 2) {
                        const level = unitParts[0];
                        const unitNumber = unitParts[1];

                        if (!levelData[level]) {
                            levelData[level] = {};
                        }

                        if (code === '') {
                            levelData[level][unitNumber] = ' ';
                        } else {
                            code = code.toUpperCase();
                            if (code === 'A' || code === 'C') {
                                levelData[level][unitNumber] = code;
                            } else {
                                levelData[level][unitNumber] = ' ';
                            }
                        }

                        unitNumbers.add(unitNumber);
                    }
                }
            });

            const unitArray = Array.from(unitNumbers).sort((a, b) => parseInt(a) - parseInt(b));

            // Store the processed data globally for use in copy function
            window.processedData = {
                levelData: levelData,
                unitArray: unitArray
            };

            displayTable(levelData, unitArray);
        }

        function displayTable(levelData, unitArray) {
            const table = document.getElementById('dataTable');
            const thead = table.getElementsByTagName('thead')[0];
            const tbody = table.getElementsByTagName('tbody')[0];
            
            thead.innerHTML = '';
            tbody.innerHTML = '';

            // Create header row
            const headerRow = thead.insertRow();
            const levelHeader = headerRow.insertCell();
            levelHeader.textContent = 'Level';
            levelHeader.style.fontWeight = 'bold';

            unitArray.forEach(unit => {
                const th = headerRow.insertCell();
                th.textContent = unit;
                th.style.fontWeight = 'bold';
            });

            // Create body rows
            const levels = Object.keys(levelData);
            const sortedLevels = levels.filter(level => level !== '01')
                .sort((a, b) => parseInt(a) - parseInt(b));
            if (levels.includes('01')) {
                sortedLevels.push('01');
            }

            sortedLevels.forEach(level => {
                const row = tbody.insertRow();
                const levelCell = row.insertCell();
                levelCell.textContent = level;

                unitArray.forEach(unit => {
                    const cell = row.insertCell();
                    const value = levelData[level][unit];
                    cell.style.backgroundColor = getColorForValue(value);
                    // Ensure cell has content even if empty
                    cell.innerHTML = '&nbsp;';
                });
            });
        }

        function getColorForValue(value) {
            if (value === 'A') return '#00FF00';
            if (value === 'C') return '#FF0000';
            if (value === undefined) return '#000000';
            return '#FFFFFF';
        }

        function clearData() {
            document.getElementById('inputData').value = '';
            document.getElementById('dataTable').getElementsByTagName('thead')[0].innerHTML = '';
            document.getElementById('dataTable').getElementsByTagName('tbody')[0].innerHTML = '';
            window.processedData = null;
        }

        function copyTable(includeLevel) {
            if (!window.processedData) {
                showMessage("Please process data first");
                return;
            }

            const { levelData, unitArray } = window.processedData;
            
            // Create a hidden div to hold our table for copying
            const container = document.createElement('div');
            container.style.position = 'fixed';
            container.style.top = '-9999px';
            document.body.appendChild(container);

            // Create a new table for copying
            const table = document.createElement('table');
            table.style.borderCollapse = 'collapse';
            container.appendChild(table);

            // Create header row
            const headerRow = table.insertRow();
            if (includeLevel) {
                const levelHeader = headerRow.insertCell();
                levelHeader.textContent = 'Level';
                levelHeader.style.border = '1px solid black';
            }

            // Add unit headers
            unitArray.forEach(unit => {
                const cell = headerRow.insertCell();
                cell.textContent = unit;
                cell.style.border = '1px solid black';
            });

            // Add data rows
            const levels = Object.keys(levelData);
            const sortedLevels = levels.filter(level => level !== '01')
                .sort((a, b) => parseInt(a) - parseInt(b));
            if (levels.includes('01')) {
                sortedLevels.push('01');
            }

            sortedLevels.forEach(level => {
                const row = table.insertRow();
                
                if (includeLevel) {
                    const levelCell = row.insertCell();
                    levelCell.textContent = level;
                    levelCell.style.border = '1px solid black';
                }

                unitArray.forEach(unit => {
                    const cell = row.insertCell();
                    const value = levelData[level][unit];
                    cell.style.backgroundColor = getColorForValue(value);
                    cell.style.border = '1px solid black';
                    cell.innerHTML = '&nbsp;'; // Ensure cell has content
                    cell.style.width = '30px';
                    cell.style.height = '20px';
                });
            });

            // Select and copy the table
            const range = document.createRange();
            range.selectNode(table);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            
            try {
                document.execCommand('copy');
                showMessage(includeLevel ? "Table copied with levels" : "Table copied without levels");
            } catch (err) {
                showMessage("Failed to copy table");
                console.error('Copy failed:', err);
            }

            // Cleanup
            document.body.removeChild(container);
            selection.removeAllRanges();
        }

        function showMessage(text) {
            const message = document.createElement('div');
            message.textContent = text;
            message.style.position = 'fixed';
            message.style.top = '0px';
            message.style.left = '50%';
            message.style.transform = 'translateX(-50%)';
            message.style.padding = '10px 20px';
            message.style.backgroundColor = '#4CAF50';
            message.style.color = '#fff';
            message.style.borderRadius = '5px';
            message.style.zIndex = '9999';
            
            document.body.appendChild(message);
            setTimeout(() => message.remove(), 2000);
        }
    </script>
</body>
</html>
